<div class="dialog" [class.mobile]="isMobile">
  <div class="dialog-header">
    <h3>Cập nhật người dùng</h3>
    <button type="button" class="close-btn" (click)="closeModal()" aria-label="Đóng" title="Đóng">×</button>
  </div>

  <form #form="ngForm" class="dialog-body" (ngSubmit)="onSubmit(form)" novalidate>
    <div class="grid">
      <!-- Username -->
      <label>
        <span>Tên đăng nhập <span class="required">*</span></span>
        <input 
          type="text" name="username" [(ngModel)]="userModel.username" 
          #username="ngModel" required autocomplete="username"
          placeholder="Nhập tên đăng nhập"
          readonly
          [ngClass]="{'invalid': form.submitted && username.invalid}" />
        <div *ngIf="form.submitted && username.errors" class="field-error">
          <span *ngIf="username.errors?.['required']">Tên đăng nhập là bắt buộc</span>
        </div>
      </label>

      <!-- Password -->
      <label>
        <span>Mật khẩu mới</span>
        <input 
          type="password" name="password" [(ngModel)]="userModel.password"
          #password="ngModel" minlength="8" autocomplete="new-password"
          placeholder="Nhập mật khẩu mới (để trống nếu không đổi)"
          [ngClass]="{'invalid': form.submitted && password.invalid}" />
        <div *ngIf="form.submitted && password.errors" class="field-error">
          <span *ngIf="password.errors?.['minlength']">Mật khẩu phải có ít nhất 8 ký tự</span>
        </div>
      </label>

      <!-- Full name -->
      <label>
        <span>Họ và tên <span class="required">*</span></span>
        <input 
          type="text" name="fullName" [(ngModel)]="userModel.fullName"
          #fullName="ngModel" required autocomplete="name"
          placeholder="Nhập họ và tên"
          [ngClass]="{'invalid': form.submitted && fullName.invalid}" />
        <div *ngIf="form.submitted && fullName.errors" class="field-error">
          <span *ngIf="fullName.errors?.['required']">Họ và tên là bắt buộc</span>
        </div>
      </label>

      <!-- Address -->
      <label>
        <span>Địa chỉ</span>
        <input type="text" name="address" [(ngModel)]="userModel.address"
               autocomplete="street-address" placeholder="Nhập địa chỉ (không bắt buộc)" />
      </label>

      <!-- Date of birth & Gender & Role -->
      <div class="date-gender-row">
        <!-- Date -->
        <label>
          <span>Ngày sinh <span class="required">*</span></span>
          <input type="date" name="dateOfBirth" [(ngModel)]="userModel.dateOfBirth"
                 #dateOfBirth="ngModel" required [max]="getMaxDate()"
                 [ngClass]="{'invalid': form.submitted && dateOfBirth.invalid}" />
          <div *ngIf="form.submitted && dateOfBirth.errors" class="field-error">
            <span *ngIf="dateOfBirth.errors?.['required']">Ngày sinh là bắt buộc</span>
          </div>
        </label>

        <!-- Gender -->
        <label>
          <span>Giới tính <span class="required">*</span></span>
          <select name="gender" [(ngModel)]="userModel.gender"
                  #gender="ngModel" required
                  [ngClass]="{'invalid': form.submitted && gender.invalid}">
            <option value="" disabled selected>Chọn giới tính</option>
            <option value="Nam">Nam</option>
            <option value="Nữ">Nữ</option>
            <option value="Khác">Khác</option>
          </select>
          <div *ngIf="form.submitted && gender.errors" class="field-error">
            <span *ngIf="gender.errors?.['required']">Giới tính là bắt buộc</span>
          </div>
        </label>

        <!-- Role -->
        <label>
          <span>Vai trò <span class="required">*</span></span>
          <select name="role" [(ngModel)]="userModel.role" (change)="onRoleChange()"
                  #role="ngModel" required
                  [ngClass]="{'invalid': form.submitted && role.invalid}">
            <option value="" disabled selected>Chọn vai trò</option>
            <option value="MANAGER">Quản lý</option>
            <option value="EMPLOYEE">Nhân viên</option>
          </select>
          <div *ngIf="form.submitted && role.errors" class="field-error">
            <span *ngIf="role.errors?.['required']">Vai trò là bắt buộc</span>
          </div>
        </label>
      </div>

      <!-- Phone & Manager -->
      <div class="phone-manager-row">
        <!-- Phone -->
        <label>
          <span>Số điện thoại <span class="required">*</span></span>
          <input type="text" name="phone" [(ngModel)]="userModel.phone"
                 #phone="ngModel" required autocomplete="tel"
                 placeholder="Nhập số điện thoại"
                 [ngClass]="{'invalid': form.submitted && phone.invalid}" />
          <div *ngIf="form.submitted && phone.errors" class="field-error">
            <span *ngIf="phone.errors?.['required']">Số điện thoại là bắt buộc</span>
          </div>
        </label>

        <!-- Manager (only if role = EMPLOYEE) -->
        <label *ngIf="userModel.role === 'EMPLOYEE'">
          <span>Quản lý phụ trách <span class="required">*</span></span>
          <select name="managerId" [(ngModel)]="userModel.managerId"
                  #managerId="ngModel" [required]="userModel.role === 'EMPLOYEE'"
                  [ngClass]="{'invalid': form.submitted && managerId.invalid}">
            <option value="" disabled selected>Chọn quản lý</option>
            <option *ngFor="let manager of managerList" [value]="manager.id">
              {{ manager.name }}
            </option>
          </select>
          <div *ngIf="form.submitted && managerId.errors" class="field-error">
            <span *ngIf="managerId.errors?.['required']">Quản lý phụ trách là bắt buộc</span>
          </div>
        </label>
      </div>
    </div>

    <!-- Actions -->
    <div class="dialog-actions">
      <button type="button" (click)="onCancel()" class="btn-cancel">Hủy</button>
      <button type="submit" class="btn-submit">
        <span *ngIf="!submitting">Lưu</span>
        <span *ngIf="submitting">Đang lưu...</span>
      </button>
    </div>

    <!-- General error -->
    <div class="error" *ngIf="error" role="alert">{{ error }}</div>
  </form>
</div>
